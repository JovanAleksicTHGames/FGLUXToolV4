<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sticky Note Calculator</title>
    <script src="https://miro.com/app/static/sdk/v2/miro.js?v=2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; margin: 0; }
        .container { max-width: 250px; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 4px; cursor: pointer; }
        .sum-btn { background: #4CAF50; color: white; }
        .product-btn { background: #2196F3; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #selection { padding: 10px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px; }
        #status { margin-top: 10px; padding: 8px; border-radius: 4px; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h3>Calculator</h3>
        <div id="selection">Select sticky notes with numbers</div>
        <button id="sumBtn" class="sum-btn" disabled>Create Sum</button>
        <button id="productBtn" class="product-btn" disabled>Create Product</button>
        <div id="status"></div>
    </div>

    <script>
        let isInitialized = false;

        // Icon click handler - this makes the app appear in toolbar
        miro.board.ui.on('icon:click', async () => {
            console.log('Icon clicked');
            await miro.board.ui.openPanel({
                url: 'https://fglux-tool-v4.vercel.app/'
            });
        });

        // Initialize when ready
        async function init() {
            if (isInitialized) return;
            
            console.log('Initializing app');
            
            // Different approach - don't use miro.ready()
            try {
                // Wait for miro to be available
                if (typeof miro === 'undefined') {
                    console.log('Miro not loaded yet, waiting...');
                    setTimeout(init, 100);
                    return;
                }
                
                // Set up the UI immediately
                setupUI();
                isInitialized = true;
                console.log('App initialized successfully');
                
            } catch (error) {
                console.error('Init error:', error);
                // Try again
                setTimeout(init, 500);
            }
        }

        function setupUI() {
            console.log('Setting up UI');
            
            const sumBtn = document.getElementById('sumBtn');
            const productBtn = document.getElementById('productBtn');
            
            if (sumBtn && productBtn) {
                sumBtn.addEventListener('click', () => calculate('sum'));
                productBtn.addEventListener('click', () => calculate('product'));
                
                // Listen for selection changes
                miro.board.ui.on('selection:update', () => {
                    console.log('Selection changed');
                    updateUI();
                });
                
                // Force initial UI update after a short delay
                setTimeout(updateUI, 500);
                
                // Also update UI when user clicks anywhere (backup)
                document.addEventListener('click', () => {
                    setTimeout(updateUI, 100);
                });
            }
        }

        async function calculate(operation) {
            console.log('Calculate:', operation);
            
            try {
                const selection = await miro.board.getSelection();
                console.log('Selection:', selection);
                
                const numbers = selection
                    .filter(item => item.type === 'sticky_note')
                    .map(item => {
                        const num = parseFloat(item.content?.trim());
                        return isNaN(num) ? null : num;
                    })
                    .filter(n => n !== null);
                
                console.log('Numbers found:', numbers);
                
                if (numbers.length < 2) {
                    showStatus('Please select at least 2 sticky notes with numbers', 'error');
                    return;
                }

                let result;
                if (operation === 'sum') {
                    result = numbers.reduce((a, b) => a + b, 0);
                } else {
                    result = numbers.reduce((a, b) => a * b, 1);
                }

                console.log('Result:', result);

                await miro.board.createStickyNote({
                    content: result.toString(),
                    style: { 
                        fillColor: operation === 'sum' ? 'light_yellow' : 'light_green' 
                    }
                });

                showStatus(`${operation} created: ${result}`, 'success');
                
            } catch (error) {
                console.error('Error in calculate:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        async function updateUI() {
            console.log('Updating UI...');
            try {
                const selection = await miro.board.getSelection();
                console.log('Current selection:', selection);
                console.log('Selection length:', selection ? selection.length : 0);
                
                if (!selection) {
                    console.log('No selection returned');
                    return;
                }
                
                const numbers = [];
                for (const item of selection) {
                    console.log('Item:', item.type, item.content);
                    if (item.type === 'sticky_note' && item.content) {
                        const num = parseFloat(item.content.trim());
                        if (!isNaN(num)) {
                            numbers.push(num);
                        }
                    }
                }
                
                console.log('Numbers found:', numbers);
                const hasEnough = numbers.length >= 2;
                console.log('Has enough numbers:', hasEnough);
                
                const sumBtn = document.getElementById('sumBtn');
                const productBtn = document.getElementById('productBtn');
                const selectionDiv = document.getElementById('selection');
                
                if (sumBtn) {
                    sumBtn.disabled = !hasEnough;
                    console.log('Sum button disabled:', !hasEnough);
                }
                if (productBtn) {
                    productBtn.disabled = !hasEnough;
                    console.log('Product button disabled:', !hasEnough);
                }
                if (selectionDiv) {
                    const text = hasEnough 
                        ? `${numbers.length} numbers selected: ${numbers.join(', ')}` 
                        : `Selected: ${selection.length} items (need 2+ with numbers)`;
                    selectionDiv.textContent = text;
                    console.log('Selection text:', text);
                }
                
            } catch (error) {
                console.error('Error in updateUI:', error);
                // Enable buttons for testing if there's an error
                const sumBtn = document.getElementById('sumBtn');
                const productBtn = document.getElementById('productBtn');
                if (sumBtn) sumBtn.disabled = false;
                if (productBtn) productBtn.disabled = false;
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            if (status) {
                status.textContent = message;
                status.className = type;
                status.style.display = 'block';
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        // Start initialization when DOM loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
