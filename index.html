<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sticky Note Calculator</title>
    <script src="https://miro.com/app/static/sdk/v2/miro.js?v=2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; margin: 0; }
        .container { max-width: 250px; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 4px; cursor: pointer; }
        .sum-btn { background: #4CAF50; color: white; }
        .product-btn { background: #2196F3; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #selection { padding: 10px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px; }
        #status { margin-top: 10px; padding: 8px; border-radius: 4px; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h3>Calculator</h3>
        <div id="selection">Select sticky notes with numbers</div>
        <button id="sumBtn" class="sum-btn" disabled>Create Sum</button>
        <button id="productBtn" class="product-btn" disabled>Create Product</button>
        <div id="status"></div>
    </div>

    <script>
        let isInitialized = false;

        // Icon click handler - this makes the app appear in toolbar
        miro.board.ui.on('icon:click', async () => {
            console.log('Icon clicked');
            await miro.board.ui.openPanel({
                url: 'https://fglux-tool-v4.vercel.app/'
            });
        });

        // Initialize when ready
        async function init() {
            if (isInitialized) return;
            
            console.log('Initializing app');
            
            // Different approach - don't use miro.ready()
            try {
                // Wait for miro to be available
                if (typeof miro === 'undefined') {
                    console.log('Miro not loaded yet, waiting...');
                    setTimeout(init, 100);
                    return;
                }
                
                // Set up the UI immediately
                setupUI();
                isInitialized = true;
                console.log('App initialized successfully');
                
            } catch (error) {
                console.error('Init error:', error);
                // Try again
                setTimeout(init, 500);
            }
        }

        function setupUI() {
            console.log('Setting up UI');
            
            const sumBtn = document.getElementById('sumBtn');
            const productBtn = document.getElementById('productBtn');
            
            if (sumBtn && productBtn) {
                sumBtn.addEventListener('click', () => calculate('sum'));
                productBtn.addEventListener('click', () => calculate('product'));
                
                // Listen for selection changes - try multiple approaches
                try {
                    miro.board.ui.on('selection:update', () => {
                        console.log('Selection changed via selection:update');
                        updateUI();
                    });
                } catch (error) {
                    console.log('selection:update listener failed:', error);
                }
                
                // Alternative: Listen for items:update in case selection events don't work
                try {
                    miro.board.ui.on('items:update', () => {
                        console.log('Items updated, checking selection');
                        updateUI();
                    });
                } catch (error) {
                    console.log('items:update listener failed:', error);
                }
                
                // Force initial UI update after a short delay
                setTimeout(updateUI, 500);
                setTimeout(updateUI, 2000); // Try again after 2 seconds
                
                // Also update UI periodically as backup
                setInterval(updateUI, 3000);
                
                // Update UI when user clicks anywhere (backup)
                document.addEventListener('click', () => {
                    setTimeout(updateUI, 100);
                });
                
                console.log('Event listeners set up');
            }
        }

        async function calculate(operation) {
            console.log('Calculate:', operation);
            
            try {
                const selection = await miro.board.getSelection();
                console.log('Selection:', selection);
                
                const validItems = selection.filter(item => item.type === 'sticky_note' && item.content);
                const numbers = validItems
                    .map(item => {
                        if (!item.content) return null;
                        // Remove HTML tags and parse number
                        const cleanContent = item.content.replace(/<[^>]*>/g, '').trim();
                        const num = parseFloat(cleanContent);
                        return isNaN(num) ? null : num;
                    })
                    .filter(n => n !== null);
                
                console.log('Numbers found:', numbers);
                
                if (numbers.length < 2) {
                    showStatus('Please select at least 2 sticky notes with numbers', 'error');
                    return;
                }

                let result;
                if (operation === 'sum') {
                    result = numbers.reduce((a, b) => a + b, 0);
                } else {
                    result = numbers.reduce((a, b) => a * b, 1);
                }

                console.log('Result:', result);

                // Position to the right of the second selected item
                const secondItem = validItems[1] || validItems[0]; // fallback to first if only one item
                const newX = secondItem.x + (secondItem.width || 200) + 800; // Add some spacing
                const newY = secondItem.y;

                console.log('Creating sticky note at position:', { x: newX, y: newY });

                const newStickyNote = await miro.board.createStickyNote({
                    content: result.toString(),
                    x: newX,
                    y: newY,
                    style: { 
                        fillColor: operation === 'sum' ? 'light_yellow' : 'light_green' 
                    }
                });

                console.log('Created sticky note:', newStickyNote);

                // Zoom to the new sticky note to make it visible
                await miro.board.viewport.zoomTo(newStickyNote);

                showStatus(`${operation} created: ${result}`, 'success');
                
            } catch (error) {
                console.error('Error in calculate:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        async function updateUI() {
            console.log('=== Updating UI ===');
            try {
                const selection = await miro.board.getSelection();
                console.log('Raw selection:', selection);
                console.log('Selection is array:', Array.isArray(selection));
                console.log('Selection length:', selection ? selection.length : 0);
                
                if (!selection || !Array.isArray(selection)) {
                    console.log('Invalid selection returned');
                    return;
                }
                
                const numbers = [];
                for (let i = 0; i < selection.length; i++) {
                    const item = selection[i];
                    console.log(`Item ${i}:`, {
                        type: item.type,
                        content: item.content,
                        id: item.id
                    });
                    
                    if (item.type === 'sticky_note' && item.content) {
                        let cleanContent = item.content.trim();
                        console.log(`Raw content: "${cleanContent}"`);
                        
                        // Remove HTML tags if present
                        cleanContent = cleanContent.replace(/<[^>]*>/g, '');
                        console.log(`Cleaned content: "${cleanContent}"`);
                        
                        const num = parseFloat(cleanContent);
                        console.log(`Parsed number: ${num}, isNaN: ${isNaN(num)}`);
                        if (!isNaN(num)) {
                            numbers.push(num);
                        }
                    }
                }
                
                console.log('Final numbers array:', numbers);
                const hasEnough = numbers.length >= 2;
                console.log('Has enough numbers (>=2):', hasEnough);
                
                const sumBtn = document.getElementById('sumBtn');
                const productBtn = document.getElementById('productBtn');
                const selectionDiv = document.getElementById('selection');
                
                console.log('Sum button element:', sumBtn);
                console.log('Product button element:', productBtn);
                
                if (sumBtn) {
                    console.log('Sum button disabled before:', sumBtn.disabled);
                    sumBtn.disabled = !hasEnough;
                    console.log('Sum button disabled after:', sumBtn.disabled);
                    // Force enable for testing
                    if (numbers.length > 0) {
                        sumBtn.disabled = false;
                        console.log('FORCED sum button enabled');
                    }
                }
                
                if (productBtn) {
                    console.log('Product button disabled before:', productBtn.disabled);
                    productBtn.disabled = !hasEnough;
                    console.log('Product button disabled after:', productBtn.disabled);
                    // Force enable for testing
                    if (numbers.length > 0) {
                        productBtn.disabled = false;
                        console.log('FORCED product button enabled');
                    }
                }
                
                if (selectionDiv) {
                    const text = `Selection: ${selection.length} items, ${numbers.length} numbers: [${numbers.join(', ')}]`;
                    selectionDiv.textContent = text;
                    console.log('Selection display text:', text);
                }
                
                console.log('=== UI Update Complete ===');
                
            } catch (error) {
                console.error('Error in updateUI:', error);
                console.error('Error stack:', error.stack);
                // Force enable buttons for testing
                const sumBtn = document.getElementById('sumBtn');
                const productBtn = document.getElementById('productBtn');
                if (sumBtn) {
                    sumBtn.disabled = false;
                    console.log('Error: forced sum button enabled');
                }
                if (productBtn) {
                    productBtn.disabled = false;
                    console.log('Error: forced product button enabled');
                }
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            if (status) {
                status.textContent = message;
                status.className = type;
                status.style.display = 'block';
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        // Start initialization when DOM loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>


