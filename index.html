<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sticky Note Calculator</title>
    <script src="https://miro.com/app/static/sdk/v2/miro.js"></script>
</head>
<body>
    <div id="root">
        <h2>Sticky Note Calculator</h2>
        <div id="selectionInfo">Select 2 or more sticky notes with numbers</div>
        <button id="sumBtn" disabled>Create Sum</button>
        <button id="productBtn" disabled>Create Product</button>
        <div id="statusMessage" style="display: none;"></div>
    </div>
    
    <script>
        // This is the CRITICAL part - without this, the app won't show up!
        miro.board.ui.on('icon:click', async () => {
            await miro.board.ui.openPanel({
                url: window.location.href
            });
        });

        // Basic app functionality
        async function init() {
            await miro.ready();
            
            document.getElementById('sumBtn').addEventListener('click', async () => {
                const selection = await miro.board.ui.getSelection();
                const numbers = selection
                    .filter(item => item.type === 'sticky_note')
                    .map(item => parseFloat(item.content))
                    .filter(n => !isNaN(n));
                
                if (numbers.length >= 2) {
                    const sum = numbers.reduce((a, b) => a + b, 0);
                    await miro.board.createStickyNote({
                        content: sum.toString(),
                        style: { fillColor: 'light_yellow' }
                    });
                    document.getElementById('statusMessage').textContent = 'Sum created!';
                    document.getElementById('statusMessage').style.display = 'block';
                }
            });

            document.getElementById('productBtn').addEventListener('click', async () => {
                const selection = await miro.board.ui.getSelection();
                const numbers = selection
                    .filter(item => item.type === 'sticky_note')
                    .map(item => parseFloat(item.content))
                    .filter(n => !isNaN(n));
                
                if (numbers.length >= 2) {
                    const product = numbers.reduce((a, b) => a * b, 1);
                    await miro.board.createStickyNote({
                        content: product.toString(),
                        style: { fillColor: 'light_green' }
                    });
                    document.getElementById('statusMessage').textContent = 'Product created!';
                    document.getElementById('statusMessage').style.display = 'block';
                }
            });

            // Update UI based on selection
            miro.board.ui.on('selection:update', async () => {
                const selection = await miro.board.ui.getSelection();
                const numbers = selection
                    .filter(item => item.type === 'sticky_note')
                    .map(item => parseFloat(item.content))
                    .filter(n => !isNaN(n));
                
                const hasEnough = numbers.length >= 2;
                document.getElementById('sumBtn').disabled = !hasEnough;
                document.getElementById('productBtn').disabled = !hasEnough;
                document.getElementById('selectionInfo').textContent = 
                    hasEnough ? `${numbers.length} numbers selected` : 'Select 2 or more sticky notes with numbers';
            });
        }

        init();
    </script>
</body>
</html>
