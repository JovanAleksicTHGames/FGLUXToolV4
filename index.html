async function addToRelationship() {
    try {
        const selection = await miro.board.getSelection();

        let calculatorResultId = null;
        const newSourceItems = [];

        for (const item of selection) {
            if (item.type !== 'sticky_note') continue;

            // Detect calculator result
            if (calculatorNotes.has(item.id)) {
                if (calculatorResultId && calculatorResultId !== item.id) {
                    // more than one different calculator result was selected
                    showStatus('Please select only one calculator result sticky.', 'error');
                    return;
                }
                calculatorResultId = item.id;
                continue;
            }

            // Otherwise: check numeric stickies
            if (item.content) {
                const cleanContent = item.content.replace(/<[^>]*>/g, '').replace(/,/g, '').trim();
                if (/^-?\d+(\.\d+)?$/.test(cleanContent) || /^\(-?\d+(\.\d+)?\)$/.test(cleanContent)) {
                    newSourceItems.push(item);
                } else {
                    const num = parseFloat(cleanContent);
                    if (!isNaN(num)) {
                        newSourceItems.push(item);
                    }
                }
            }
        }

        if (!calculatorResultId) {
            showStatus('No calculator result selected.', 'error');
            return;
        }
        if (newSourceItems.length === 0) {
            showStatus('Please select at least one numeric sticky note to add.', 'error');
            return;
        }

        const calcData = calculatorNotes.get(calculatorResultId);
        if (!calcData) {
            showStatus('Calculator relationship not found', 'error');
            return;
        }

        // Add unique new IDs
        const existingSet = new Set(calcData.sourceIds || []);
        const toAddIds = newSourceItems
            .map(it => it.id)
            .filter(id => !existingSet.has(id));

        if (toAddIds.length === 0) {
            showStatus('Selected items are already part of this relationship.', 'info');
            return;
        }

        calcData.sourceIds = [...existingSet, ...toAddIds];
        calculatorNotes.set(calculatorResultId, calcData);

        await recalculateResult(calculatorResultId, calcData);
        await saveCalculatorData();

        showStatus(`Added ${toAddIds.length} item(s) to ${calcData.operation || 'the'} relationship`, 'success');

        const relationshipsList = document.getElementById('relationshipsList');
        if (relationshipsList && relationshipsList.style.display !== 'none') {
            await updateRelationshipsList();
        }

    } catch (error) {
        console.error('Error adding to relationship:', error);
        showStatus('Error adding to relationship: ' + (error.message || error), 'error');
    }
}
