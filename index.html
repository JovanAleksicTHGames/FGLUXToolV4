<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sticky Note Calculator</title>
    <script src="https://miro.com/app/static/sdk/v2/miro.js?v=3"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; margin: 0; }
        .container { max-width: 250px; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 4px; cursor: pointer; }
        .sum-btn { background: #4CAF50; color: white; }
        .product-btn { background: #2196F3; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #selection { padding: 10px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px; }
        #status { margin-top: 10px; padding: 8px; border-radius: 4px; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h3>Calculator</h3>
        <div id="selection">Select sticky notes with numbers</div>
        <button id="sumBtn" class="sum-btn" disabled>Create Sum</button>
        <button id="productBtn" class="product-btn" disabled>Create Product</button>
        <div id="status"></div>
    </div>

    <script>
        let isInitialized = false;
        let calculatorNotes = new Map(); // Track result notes and their source notes
        let lastUIUpdate = 0; // Rate limiting for UI updates
        let lastCalculatorCheck = 0; // Rate limiting for calculator checks

        // Icon click handler - this makes the app appear in toolbar
        miro.board.ui.on('icon:click', async () => {
            console.log('Icon clicked');
            await miro.board.ui.openPanel({
                url: 'https://fglux-tool-v4.vercel.app/'
            });
        });

        // Initialize when ready
        async function init() {
            if (isInitialized) return;
            
            console.log('Initializing app');
            
            try {
                // Wait for miro to be available
                if (typeof miro === 'undefined') {
                    console.log('Miro not loaded yet, waiting...');
                    setTimeout(init, 100);
                    return;
                }
                
                // Set up the UI immediately
                setupUI();
                
                // Load any existing calculator data
                await loadCalculatorData();
                
                isInitialized = true;
                console.log('App initialized successfully');
                
            } catch (error) {
                console.error('Init error:', error);
                setTimeout(init, 500);
            }
        }

        function setupUI() {
            console.log('Setting up UI');
            
            const sumBtn = document.getElementById('sumBtn');
            const productBtn = document.getElementById('productBtn');
            
            if (sumBtn && productBtn) {
                sumBtn.addEventListener('click', () => calculate('sum'));
                productBtn.addEventListener('click', () => calculate('product'));
                
                // Listen for selection changes - try multiple approaches
                try {
                    miro.board.ui.on('selection:update', () => {
                        console.log('Selection changed via selection:update');
                        throttledUpdateUI();
                    });
                } catch (error) {
                    console.log('selection:update listener failed:', error);
                }
                
                // Listen for items being updated (for dynamic recalculation)
                try {
                    miro.board.ui.on('items:update', (event) => {
                        console.log('Items updated, checking for parent changes');
                        handleItemsUpdate(event);
                    });
                } catch (error) {
                    console.log('items:update listener failed:', error);
                }
                
                // Force initial UI update after delays (reduced frequency)
                setTimeout(throttledUpdateUI, 1000);
                
                // Reduced frequency periodic check (every 10 seconds instead of 2)
                setInterval(() => {
                    if (calculatorNotes.size > 0) {
                        const now = Date.now();
                        if (now - lastCalculatorCheck > 10000) { // Only every 10 seconds
                            console.log('Periodic check of calculator notes');
                            lastCalculatorCheck = now;
                            recheckAllCalculatorNotes();
                        }
                    }
                }, 10000);
                
                console.log('Event listeners set up');
            }
        }

        async function calculate(operation) {
            console.log('Calculate:', operation);
            
            try {
                const selection = await miro.board.getSelection();
                console.log('Selection:', selection);
                
                const validItems = selection.filter(item => item.type === 'sticky_note' && item.content);
                const numbers = validItems
                    .map(item => {
                        if (!item.content) return null;
                        // Remove HTML tags and parse number
                        const cleanContent = item.content.replace(/<[^>]*>/g, '').trim();
                        const num = parseFloat(cleanContent);
                        return isNaN(num) ? null : num;
                    })
                    .filter(n => n !== null);
                
                console.log('Numbers found:', numbers);
                
                if (numbers.length < 2) {
                    showStatus('Please select at least 2 sticky notes with numbers', 'error');
                    return;
                }

                let result;
                if (operation === 'sum') {
                    result = numbers.reduce((a, b) => a + b, 0);
                } else {
                    result = numbers.reduce((a, b) => a * b, 1);
                }

                console.log('Result:', result);

                // Position to the right of the LAST selected item
                const lastItem = validItems[validItems.length - 1];
                const newX = lastItem.x + (lastItem.width || 200) + 50;
                const newY = lastItem.y;

                console.log('Creating sticky note at position:', { x: newX, y: newY });

                const newStickyNote = await miro.board.createStickyNote({
                    content: result.toString(),
                    x: newX,
                    y: newY,
                    style: { 
                        fillColor: operation === 'sum' ? 'light_yellow' : 'light_green' 
                    }
                });

                console.log('Created sticky note:', newStickyNote);

                // Store the relationship between result note and source notes
                const sourceIds = validItems.map(item => item.id);
                calculatorNotes.set(newStickyNote.id, {
                    operation: operation,
                    sourceIds: sourceIds,
                    created: Date.now()
                });

                console.log('Stored calculator relationship:', {
                    resultId: newStickyNote.id,
                    operation: operation,
                    sourceIds: sourceIds
                });

                // Save to board metadata for persistence
                await saveCalculatorData();

                // Zoom to the new sticky note to make it visible
                await miro.board.viewport.zoomTo(newStickyNote);

                showStatus(`${operation} created: ${result}`, 'success');
                
            } catch (error) {
                console.error('Error in calculate:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Rate-limited UI update function
        function throttledUpdateUI() {
            const now = Date.now();
            if (now - lastUIUpdate > 1000) { // Only allow UI updates every 1 second
                lastUIUpdate = now;
                updateUI();
            } else {
                console.log('UI update throttled (too frequent)');
            }
        }

        async function updateUI() {
            console.log('=== Updating UI ===');
            try {
                const selection = await miro.board.getSelection();
                
                if (!selection || !Array.isArray(selection)) {
                    console.log('Invalid selection returned');
                    return;
                }
                
                const numbers = [];
                for (let i = 0; i < selection.length; i++) {
                    const item = selection[i];
                    
                    if (item.type === 'sticky_note' && item.content) {
                        let cleanContent = item.content.trim();
                        cleanContent = cleanContent.replace(/<[^>]*>/g, '');
                        const num = parseFloat(cleanContent);
                        if (!isNaN(num)) {
                            numbers.push(num);
                        }
                    }
                }
                
                const hasEnough = numbers.length >= 2;
                
                const sumBtn = document.getElementById('sumBtn');
                const productBtn = document.getElementById('productBtn');
                const selectionDiv = document.getElementById('selection');
                
                if (sumBtn) {
                    sumBtn.disabled = !hasEnough;
                    if (numbers.length > 0) {
                        sumBtn.disabled = false; // Force enable if any numbers
                    }
                }
                
                if (productBtn) {
                    productBtn.disabled = !hasEnough;
                    if (numbers.length > 0) {
                        productBtn.disabled = false; // Force enable if any numbers
                    }
                }
                
                if (selectionDiv) {
                    const text = `Selection: ${selection.length} items, ${numbers.length} numbers: [${numbers.join(', ')}]`;
                    selectionDiv.textContent = text;
                }
                
            } catch (error) {
                console.error('Error in updateUI:', error);
                const sumBtn = document.getElementById('sumBtn');
                const productBtn = document.getElementById('productBtn');
                if (sumBtn) sumBtn.disabled = false;
                if (productBtn) productBtn.disabled = false;
            }
        }

        // Check all calculator notes for updates (backup method)
        async function recheckAllCalculatorNotes() {
            for (const [resultId, calcData] of calculatorNotes.entries()) {
                await recalculateResult(resultId, calcData);
            }
        }
        async function handleItemsUpdate(event) {
            console.log('Items update event:', event);
            
            for (const updatedItem of event.items) {
                console.log('Updated item:', updatedItem.id, updatedItem.type);
                
                if (updatedItem.type === 'sticky_note') {
                    // Check if this updated item is a source for any calculator notes
                    for (const [resultId, calcData] of calculatorNotes.entries()) {
                        if (calcData.sourceIds.includes(updatedItem.id)) {
                            console.log(`Found calculator note ${resultId} that depends on updated item ${updatedItem.id}`);
                            await recalculateResult(resultId, calcData);
                        }
                    }
                }
            }
        }

        // Recalculate a result sticky note based on current source values
        async function recalculateResult(resultId, calcData) {
            try {
                console.log('Recalculating result note:', resultId);
                console.log('Calc data:', calcData);
                
                // Get current values of all source notes
                const sourceValues = [];
                const validSourceIds = [];
                
                for (const sourceId of calcData.sourceIds) {
                    try {
                        console.log('Checking source ID:', sourceId);
                        const sourceItem = await miro.board.getById(sourceId);
                        console.log('Source item:', sourceItem);
                        
                        if (sourceItem && sourceItem.type === 'sticky_note' && sourceItem.content) {
                            const cleanContent = sourceItem.content.replace(/<[^>]*>/g, '').trim();
                            console.log('Clean content:', cleanContent);
                            const num = parseFloat(cleanContent);
                            console.log('Parsed number:', num);
                            if (!isNaN(num)) {
                                sourceValues.push(num);
                                validSourceIds.push(sourceId);
                            }
                        }
                    } catch (error) {
                        console.log('Source note not found or error:', sourceId, error.message);
                    }
                }
                
                console.log('Current source values:', sourceValues);
                
                if (sourceValues.length < 2) {
                    console.log('Not enough valid source values, removing calculator note');
                    try {
                        await miro.board.deleteItem(resultId);
                        calculatorNotes.delete(resultId);
                        await saveCalculatorData();
                    } catch (error) {
                        console.log('Error removing calculator note (might already be gone):', error.message);
                        // Clean up from our tracking anyway
                        calculatorNotes.delete(resultId);
                        await saveCalculatorData();
                    }
                    return;
                }
                
                // Calculate new result
                let newResult;
                if (calcData.operation === 'sum') {
                    newResult = sourceValues.reduce((a, b) => a + b, 0);
                } else {
                    newResult = sourceValues.reduce((a, b) => a * b, 1);
                }
                
                console.log('New calculated result:', newResult);
                
                // Update the result sticky note
                try {
                    const resultItem = await miro.board.getById(resultId);
                    console.log('Result item before update:', resultItem);
                    if (resultItem) {
                        resultItem.content = newResult.toString();
                        await resultItem.sync();
                        console.log('âœ… Updated result note with new value:', newResult);
                    }
                } catch (error) {
                    console.log('Result note no longer exists:', resultId, error.message);
                    calculatorNotes.delete(resultId);
                    await saveCalculatorData();
                }
                
            } catch (error) {
                console.error('Error in recalculateResult:', error);
            }
        }

        // Save calculator data to board metadata
        async function saveCalculatorData() {
            try {
                const data = Object.fromEntries(calculatorNotes);
                await miro.board.setAppData('calculatorNotes', data);
                console.log('Saved calculator data to board metadata');
            } catch (error) {
                console.error('Error saving calculator data:', error);
            }
        }

        // Load calculator data from board metadata
        async function loadCalculatorData() {
            try {
                const data = await miro.board.getAppData('calculatorNotes');
                if (data) {
                    calculatorNotes = new Map(Object.entries(data));
                    console.log('Loaded calculator data:', calculatorNotes);
                } else {
                    console.log('No existing calculator data found');
                }
            } catch (error) {
                console.error('Error loading calculator data:', error);
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            if (status) {
                status.textContent = message;
                status.className = type;
                status.style.display = 'block';
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        // Start initialization when DOM loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
