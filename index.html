<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sticky Note Calculator</title>
    <script src="https://miro.com/app/static/sdk/v2/miro.js?v=3"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; margin: 0; }
        .container { max-width: 250px; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 4px; cursor: pointer; }
        .sum-btn { background: #4CAF50; color: white; }
        .product-btn { background: #2196F3; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #selection { padding: 10px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px; }
        #status { margin-top: 10px; padding: 8px; border-radius: 4px; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        
        .spawn-section { 
            margin: 15px 0; 
            padding: 12px; 
            background: #f8f9fa; 
            border-radius: 6px; 
            border: 1px solid #e9ecef; 
        }
        .spawn-label { 
            font-size: 12px; 
            font-weight: 500; 
            margin-bottom: 6px; 
            color: #495057; 
        }
        .spawn-input { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            font-size: 14px; 
            margin-bottom: 8px; 
        }
        .spawn-btn { 
            width: 100%; 
            padding: 10px; 
            background: #6c757d; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            font-size: 13px; 
            cursor: pointer; 
        }
        .spawn-btn:hover { background: #5a6268; }
        
        .relationships-section { margin-top: 20px; }
        .toggle-btn { 
            width: 100%; 
            padding: 8px; 
            background: #f8f9fa; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 12px;
            text-align: left;
        }
        .toggle-btn:hover { background: #e9ecef; }
        .relationships-list { 
            border: 1px solid #ddd; 
            border-top: none; 
            border-radius: 0 0 4px 4px; 
            max-height: 200px; 
            overflow-y: auto;
        }
        #relationshipsContent { padding: 10px; font-size: 11px; }
        .relationship-item { 
            padding: 8px; 
            margin: 4px 0; 
            background: #f8f9fa; 
            border-radius: 3px; 
            border-left: 3px solid #007bff;
        }
        .relationship-item.sum { border-left-color: #ffc107; }
        .relationship-item.product { border-left-color: #28a745; }
        .relationship-item.invalid { border-left-color: #dc3545; background: #fff5f5; }
        .relationship-header { font-weight: bold; margin-bottom: 4px; cursor: pointer; }
        .relationship-header:hover { color: #007bff; text-decoration: underline; }
        .relationship-sources { font-size: 10px; color: #666; }
        .relationship-result { font-size: 10px; color: #333; margin-top: 2px; }
        .relationship-actions { 
            margin-top: 6px; 
            display: flex; 
            gap: 5px; 
        }
        .action-btn { 
            font-size: 9px; 
            padding: 2px 6px; 
            border: none; 
            border-radius: 2px; 
            cursor: pointer; 
            background: #dc3545; 
            color: white; 
        }
        .action-btn:hover { background: #c82333; }
        .action-btn:disabled { background: #ccc; cursor: not-allowed; }
        .goto-btn { background: #007bff; }
        .goto-btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h3>Calculator</h3>
        <div id="selection">Select sticky notes with numbers</div>
        <button id="sumBtn" class="sum-btn" disabled>Create Sum</button>
        <button id="productBtn" class="product-btn" disabled>Create Product</button>
        <div id="status"></div>
        
        <!-- Spawn feature -->
        <div class="spawn-section">
            <div class="spawn-label">Input number to spawn:</div>
            <input type="number" id="spawnCount" class="spawn-input" min="1" max="20" value="3" placeholder="3">
            <button id="spawnBtn" class="spawn-btn">Spawn</button>
        </div>
        
        <!-- Expandable relationships overview -->
        <div class="relationships-section">
            <button id="toggleRelationships" class="toggle-btn">
                ‚ñº Show Relationships (<span id="relationshipCount">0</span>)
            </button>
            <div id="relationshipsList" class="relationships-list" style="display: none;">
                <div id="relationshipsContent">No calculator relationships found</div>
            </div>
        </div>
    </div>

    <script>
        let isInitialized = false;
        let calculatorNotes = new Map(); // Track result notes and their source notes
        let lastUIUpdate = 0; // Rate limiting for UI updates
        let lastCalculatorCheck = 0; // Rate limiting for calculator checks

        // Icon click handler - this makes the app appear in toolbar
        miro.board.ui.on('icon:click', async () => {
            console.log('Icon clicked');
            await miro.board.ui.openPanel({
                url: 'https://fglux-tool-v4.vercel.app/'
            });
        });

        // Initialize when ready
        async function init() {
            if (isInitialized) return;
            
            console.log('Initializing app');
            
            try {
                // Wait for miro to be available
                if (typeof miro === 'undefined') {
                    console.log('Miro not loaded yet, waiting...');
                    setTimeout(init, 100);
                    return;
                }
                
                // Set up the UI immediately
                setupUI();
                
                // Load any existing calculator data
                await loadCalculatorData();
                
                // Update relationships count
                updateRelationshipsCount();
                
                isInitialized = true;
                console.log('App initialized successfully');
                
            } catch (error) {
                console.error('Init error:', error);
                setTimeout(init, 500);
            }
        }

        function setupUI() {
            console.log('Setting up UI');
            
            const sumBtn = document.getElementById('sumBtn');
            const productBtn = document.getElementById('productBtn');
            
            if (sumBtn && productBtn) {
                sumBtn.addEventListener('click', () => calculate('sum'));
                productBtn.addEventListener('click', () => calculate('product'));
                
                // Set up spawn button
                const spawnBtn = document.getElementById('spawnBtn');
                if (spawnBtn) {
                    spawnBtn.addEventListener('click', spawnStickyNotes);
                }
                
                // Set up relationships toggle
                const toggleBtn = document.getElementById('toggleRelationships');
                const relationshipsList = document.getElementById('relationshipsList');
                
                if (toggleBtn && relationshipsList) {
                    toggleBtn.addEventListener('click', () => {
                        const isVisible = relationshipsList.style.display !== 'none';
                        relationshipsList.style.display = isVisible ? 'none' : 'block';
                        toggleBtn.innerHTML = isVisible 
                            ? `‚ñº Show Relationships (<span id="relationshipCount">${calculatorNotes.size}</span>)`
                            : `‚ñ≤ Hide Relationships (<span id="relationshipCount">${calculatorNotes.size}</span>)`;
                        
                        if (!isVisible) {
                            updateRelationshipsList();
                        }
                    });
                }
                
                // Listen for selection changes - throttled
                try {
                    miro.board.ui.on('selection:update', () => {
                        console.log('Selection changed via selection:update');
                        throttledUpdateUI();
                    });
                } catch (error) {
                    console.log('selection:update listener failed:', error);
                }
                
                // Listen for items being updated (for dynamic recalculation)
                try {
                    miro.board.ui.on('items:update', (event) => {
                        console.log('Items updated, checking for parent changes');
                        throttledHandleItemsUpdate(event);
                    });
                } catch (error) {
                    console.log('items:update listener failed:', error);
                }
                
                // Force initial UI update
                setTimeout(throttledUpdateUI, 1000);
                
                // Update UI when user clicks in the panel (but throttled)
                document.addEventListener('click', () => {
                    setTimeout(throttledUpdateUI, 100);
                });
                
                // Reduced frequency periodic check (every 10 seconds)
                setInterval(() => {
                    if (calculatorNotes.size > 0) {
                        console.log('Periodic check of calculator notes');
                        throttledRecheckAllCalculatorNotes();
                    }
                }, 10000);
                
                console.log('Event listeners set up');
            }
        }

        async function calculate(operation) {
            console.log('Calculate:', operation);
            
            try {
                const selection = await miro.board.getSelection();
                console.log('Selection:', selection);
                
                const validItems = selection.filter(item => item.type === 'sticky_note' && item.content);
                const numbers = validItems
                    .map(item => {
                        if (!item.content) return null;
                        // Remove HTML tags and parse number
                        const cleanContent = item.content.replace(/<[^>]*>/g, '').trim();
                        const num = parseFloat(cleanContent);
                        return isNaN(num) ? null : num;
                    })
                    .filter(n => n !== null);
                
                console.log('Numbers found:', numbers);
                
                if (numbers.length < 2) {
                    showStatus('Please select at least 2 sticky notes with numbers', 'error');
                    return;
                }

                let result;
                if (operation === 'sum') {
                    result = numbers.reduce((a, b) => a + b, 0);
                } else {
                    result = numbers.reduce((a, b) => a * b, 1);
                }

                console.log('Result:', result);

                // Position to the right of the LAST selected item
                const lastItem = validItems[validItems.length - 1];
                const newX = lastItem.x + (lastItem.width || 200) + 50;
                const newY = lastItem.y;

                console.log('Creating sticky note at position:', { x: newX, y: newY });

                const newStickyNote = await miro.board.createStickyNote({
                    content: result.toString(),
                    x: newX,
                    y: newY,
                    style: { 
                        fillColor: operation === 'sum' ? 'light_yellow' : 'light_green' 
                    }
                });

                console.log('Created sticky note:', newStickyNote);

                // Store the relationship between result note and source notes
                const sourceIds = validItems.map(item => item.id);
                calculatorNotes.set(newStickyNote.id, {
                    operation: operation,
                    sourceIds: sourceIds,
                    created: Date.now()
                });

                console.log('Stored calculator relationship:', {
                    resultId: newStickyNote.id,
                    operation: operation,
                    sourceIds: sourceIds
                });

                // Save to board metadata for persistence
                await saveCalculatorData();
                
                // Update relationships display
                updateRelationshipsCount();

                // Zoom to the new sticky note to make it visible
                await miro.board.viewport.zoomTo(newStickyNote);

                showStatus(`${operation} created: ${result}`, 'success');
                
            } catch (error) {
                console.error('Error in calculate:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Rate-limited versions of functions
        function throttledUpdateUI() {
            const now = Date.now();
            if (now - lastUIUpdate > 1000) { // Only allow UI updates every 1 second
                lastUIUpdate = now;
                updateUI();
            }
        }

        function throttledHandleItemsUpdate(event) {
            const now = Date.now();
            if (now - lastCalculatorCheck > 2000) { // Allow calculator checks every 2 seconds
                lastCalculatorCheck = now;
                handleItemsUpdate(event);
            }
        }

        function throttledRecheckAllCalculatorNotes() {
            const now = Date.now();
            if (now - lastCalculatorCheck > 5000) { // Only every 5 seconds for periodic checks
                lastCalculatorCheck = now;
                recheckAllCalculatorNotes();
            }
        }

        async function updateUI() {
            console.log('=== Updating UI ===');
            try {
                const selection = await miro.board.getSelection();
                
                if (!selection || !Array.isArray(selection)) {
                    console.log('Invalid selection returned');
                    return;
                }
                
                const numbers = [];
                for (let i = 0; i < selection.length; i++) {
                    const item = selection[i];
                    
                    if (item.type === 'sticky_note' && item.content) {
                        let cleanContent = item.content.trim();
                        cleanContent = cleanContent.replace(/<[^>]*>/g, '');
                        const num = parseFloat(cleanContent);
                        if (!isNaN(num)) {
                            numbers.push(num);
                        }
                    }
                }
                
                const hasEnough = numbers.length >= 2;
                
                const sumBtn = document.getElementById('sumBtn');
                const productBtn = document.getElementById('productBtn');
                const selectionDiv = document.getElementById('selection');
                
                if (sumBtn) {
                    sumBtn.disabled = !hasEnough;
                    if (numbers.length > 0) {
                        sumBtn.disabled = false; // Force enable if any numbers
                    }
                }
                
                if (productBtn) {
                    productBtn.disabled = !hasEnough;
                    if (numbers.length > 0) {
                        productBtn.disabled = false; // Force enable if any numbers
                    }
                }
                
                if (selectionDiv) {
                    const text = `Selection: ${selection.length} items, ${numbers.length} numbers: [${numbers.join(', ')}]`;
                    selectionDiv.textContent = text;
                }
                
            } catch (error) {
                console.error('Error in updateUI:', error);
                const sumBtn = document.getElementById('sumBtn');
                const productBtn = document.getElementById('productBtn');
                if (sumBtn) sumBtn.disabled = false;
                if (productBtn) productBtn.disabled = false;
            }
        }

        // Update relationships list display - only show valid relationships
        async function updateRelationshipsList() {
            const content = document.getElementById('relationshipsContent');
            if (!content) return;
            
            console.log('Updating relationships list, current count:', calculatorNotes.size);
            
            // Quick verification before displaying
            await verifyAndCleanupRelationships();
            
            if (calculatorNotes.size === 0) {
                content.innerHTML = 'No calculator relationships found';
                return;
            }
            
            let html = '';
            let displayedCount = 0;
            
            for (const [resultId, calcData] of calculatorNotes.entries()) {
                try {
                    // Get result note info
                    let resultContent = 'Loading...';
                    let resultExists = false;
                    
                    try {
                        const resultNote = await miro.board.getById(resultId);
                        if (resultNote && resultNote.content) {
                            resultContent = resultNote.content.replace(/<[^>]*>/g, '').trim();
                            resultExists = true;
                        }
                    } catch (error) {
                        // This relationship should have been cleaned up
                        continue;
                    }
                    
                    // Get source notes info
                    const sourceInfos = [];
                    let validSourceCount = 0;
                    
                    for (const sourceId of calcData.sourceIds) {
                        try {
                            const sourceNote = await miro.board.getById(sourceId);
                            if (sourceNote && sourceNote.content) {
                                const content = sourceNote.content.replace(/<[^>]*>/g, '').trim();
                                sourceInfos.push(content);
                                validSourceCount++;
                            }
                        } catch (error) {
                            // Source note missing - this relationship should have been cleaned up
                        }
                    }
                    
                    // Only display if we have valid result and sufficient sources
                    if (resultExists && validSourceCount >= 2) {
                        const operationSymbol = calcData.operation === 'sum' ? '+' : '√ó';
                        const sourceText = sourceInfos.join(` ${operationSymbol} `);
                        
                        html += `
                            <div class="relationship-item ${calcData.operation}">
                                <div class="relationship-header" onclick="goToResultNote('${resultId}')" title="Click to go to result note">
                                    ${calcData.operation.toUpperCase()}: ${resultContent}
                                </div>
                                <div class="relationship-sources">
                                    Sources: ${sourceText}
                                </div>
                                <div class="relationship-result">
                                    Result ID: ${resultId.slice(-8)}... | ${validSourceCount} sources
                                </div>
                                <div class="relationship-actions">
                                    <button class="action-btn goto-btn" onclick="goToResultNote('${resultId}')" title="Go to result note">
                                        Go To
                                    </button>
                                    <button class="action-btn" onclick="deleteRelationship('${resultId}')" title="Delete relationship and all related notes">
                                        Delete All
                                    </button>
                                </div>
                            </div>
                        `;
                        displayedCount++;
                    }
                    
                } catch (error) {
                    console.error('Error displaying relationship:', error);
                }
            }
            
            if (displayedCount === 0) {
                content.innerHTML = 'No valid calculator relationships found';
            } else {
                content.innerHTML = html;
                console.log(`‚úÖ Displayed ${displayedCount} valid relationships`);
            }
        }
        
        // Update relationships count
        function updateRelationshipsCount() {
            const countElement = document.getElementById('relationshipCount');
            if (countElement) {
                countElement.textContent = calculatorNotes.size;
            }
        }

        // Spawn sticky notes with arrows
        async function spawnStickyNotes() {
            try {
                const countInput = document.getElementById('spawnCount');
                const count = parseInt(countInput.value) || 3;
                
                if (count < 1 || count > 20) {
                    showStatus('Please enter a number between 1 and 20', 'error');
                    return;
                }
                
                console.log(`Spawning ${count} sticky notes with arrows`);
                showStatus(`Spawning ${count} sticky notes...`, 'success');
                
                const stickyNotes = [];
                const startX = 0;
                const startY = 0;
                const spacing = 400;
                
                // Create sticky notes
                for (let i = 0; i < count; i++) {
                    const stickyNote = await miro.board.createStickyNote({
                        content: `${i + 1}`,
                        x: startX + (i * spacing),
                        y: startY,
                        style: {
                            fillColor: 'light_blue'
                        }
                    });
                    stickyNotes.push(stickyNote);
                    console.log(`Created sticky note ${i + 1}:`, stickyNote.id);
                }
                
                // Create arrows/connectors between consecutive notes
                for (let i = 0; i < stickyNotes.length - 1; i++) {
                    try {
                        const startNote = stickyNotes[i];
                        const endNote = stickyNotes[i + 1];
                        
                        const connector = await miro.board.createConnector({
                            start: {
                                item: startNote.id,
                                snapTo: 'right'
                            },
                            end: {
                                item: endNote.id,
                                snapTo: 'left'
                            },
                            style: {
                                strokeColor: '#1976d2',
                                strokeWidth: 2
                            }
                        });
                        
                        console.log(`Created connector ${i + 1}:`, connector.id);
                    } catch (connectorError) {
                        console.log('Could not create connector:', connectorError.message);
                        // Continue even if connector creation fails
                    }
                }
                
                // Zoom to show all created notes
                if (stickyNotes.length > 0) {
                    await miro.board.viewport.zoomTo(stickyNotes);
                }
                
                showStatus(`Successfully spawned ${count} sticky notes with arrows!`, 'success');
                
            } catch (error) {
                console.error('Error spawning sticky notes:', error);
                showStatus('Error spawning sticky notes: ' + error.message, 'error');
            }
        }

        // Navigate to result note (global function for onclick)
        window.goToResultNote = async function(resultId) {
            try {
                console.log('Navigating to result note:', resultId);
                const resultNote = await miro.board.getById(resultId);
                if (resultNote) {
                    await miro.board.viewport.zoomTo(resultNote);
                    // Also select the note to highlight it
                    await miro.board.select({ id: resultId });
                    showStatus('Navigated to result note', 'success');
                } else {
                    showStatus('Result note not found', 'error');
                }
            } catch (error) {
                console.error('Error navigating to result note:', error);
                showStatus('Error: Result note may have been deleted', 'error');
            }
        }

        // Delete relationship and all related notes
        window.deleteRelationship = async function(resultId) {
            try {
                const calcData = calculatorNotes.get(resultId);
                if (!calcData) {
                    showStatus('Relationship not found', 'error');
                    return;
                }

                const confirmMessage = `Delete this relationship and ALL related notes?\n\nThis will delete:\n- The result note (${calcData.operation})\n- All ${calcData.sourceIds.length} source notes\n\nThis action cannot be undone.`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }

                console.log('Deleting relationship and all notes for:', resultId);
                let deletedCount = 0;
                let errors = [];

                // Create array of all IDs to delete (sources + result)
                const idsToDelete = [...calcData.sourceIds, resultId];
                console.log('IDs to delete:', idsToDelete);

                // Try to delete all notes in one batch first
                try {
                    // Get all item objects for batch deletion
                    const itemObjects = [];
                    for (const itemId of idsToDelete) {
                        try {
                            const item = await miro.board.getById(itemId);
                            if (item) itemObjects.push(item);
                        } catch (error) {
                            console.log('Item not found:', itemId);
                        }
                    }
                    
                    // Remove all items
                    for (const item of itemObjects) {
                        await miro.board.remove(item);
                        deletedCount++;
                    }
                    console.log('‚úÖ Batch removed all notes successfully');
                } catch (batchError) {
                    console.log('‚ùå Batch remove failed, trying individually:', batchError.message);
                    deletedCount = 0; // Reset counter
                    
                    // If batch remove fails, try one by one
                    for (const itemId of idsToDelete) {
                        try {
                            // Verify the note exists first
                            const item = await miro.board.getById(itemId);
                            if (item) {
                                await miro.board.remove(item);
                                deletedCount++;
                                console.log('‚úÖ Individually removed:', itemId);
                            } else {
                                console.log('Note already gone:', itemId);
                            }
                        } catch (error) {
                            console.log('‚ùå Could not remove note:', itemId, error.message);
                            errors.push(`${itemId.slice(-8)}: ${error.message}`);
                        }
                    }
                }

                // Remove from tracking regardless of deletion success
                calculatorNotes.delete(resultId);
                await saveCalculatorData();
                updateRelationshipsCount();
                
                // Refresh the relationships list
                await updateRelationshipsList();

                // Show results
                if (errors.length > 0) {
                    console.error('Deletion errors:', errors);
                    showStatus(`Deleted ${deletedCount} notes, ${errors.length} errors`, 'error');
                } else {
                    showStatus(`Successfully deleted ${deletedCount} notes`, 'success');
                }
                
            } catch (error) {
                console.error('Error deleting relationship:', error);
                showStatus('Error deleting relationship: ' + error.message, 'error');
            }
        }
        async function recheckAllCalculatorNotes() {
            for (const [resultId, calcData] of calculatorNotes.entries()) {
                await recalculateResult(resultId, calcData);
            }
        }
        async function handleItemsUpdate(event) {
            console.log('Items update event:', event);
            
            for (const updatedItem of event.items) {
                console.log('Updated item:', updatedItem.id, updatedItem.type);
                
                if (updatedItem.type === 'sticky_note') {
                    // Check if this updated item is a source for any calculator notes
                    for (const [resultId, calcData] of calculatorNotes.entries()) {
                        if (calcData.sourceIds.includes(updatedItem.id)) {
                            console.log(`Found calculator note ${resultId} that depends on updated item ${updatedItem.id}`);
                            await recalculateResult(resultId, calcData);
                        }
                    }
                }
            }
        }

        // Recalculate a result sticky note based on current source values
        async function recalculateResult(resultId, calcData) {
            try {
                console.log('Recalculating result note:', resultId);
                console.log('Calc data:', calcData);
                
                // Get current values of all source notes
                const sourceValues = [];
                const validSourceIds = [];
                
                for (const sourceId of calcData.sourceIds) {
                    try {
                        console.log('Checking source ID:', sourceId);
                        const sourceItem = await miro.board.getById(sourceId);
                        console.log('Source item:', sourceItem);
                        
                        if (sourceItem && sourceItem.type === 'sticky_note' && sourceItem.content) {
                            const cleanContent = sourceItem.content.replace(/<[^>]*>/g, '').trim();
                            console.log('Clean content:', cleanContent);
                            const num = parseFloat(cleanContent);
                            console.log('Parsed number:', num);
                            if (!isNaN(num)) {
                                sourceValues.push(num);
                                validSourceIds.push(sourceId);
                            }
                        }
                    } catch (error) {
                        console.log('Source note not found or error:', sourceId, error.message);
                    }
                }
                
                console.log('Current source values:', sourceValues);
                
                if (sourceValues.length < 2) {
                    console.log('Not enough valid source values, removing calculator note');
                    try {
                        await miro.board.deleteItem(resultId);
                        calculatorNotes.delete(resultId);
                        await saveCalculatorData();
                        updateRelationshipsCount();
                    } catch (error) {
                        console.log('Error removing calculator note (might already be gone):', error.message);
                        // Clean up from our tracking anyway
                        calculatorNotes.delete(resultId);
                        await saveCalculatorData();
                    }
                    return;
                }
                
                // Calculate new result
                let newResult;
                if (calcData.operation === 'sum') {
                    newResult = sourceValues.reduce((a, b) => a + b, 0);
                } else {
                    newResult = sourceValues.reduce((a, b) => a * b, 1);
                }
                
                console.log('New calculated result:', newResult);
                
                // Update the result sticky note
                try {
                    const resultItem = await miro.board.getById(resultId);
                    console.log('Result item before update:', resultItem);
                    if (resultItem) {
                        resultItem.content = newResult.toString();
                        await resultItem.sync();
                        console.log('‚úÖ Updated result note with new value:', newResult);
                    }
                } catch (error) {
                    console.log('Result note no longer exists:', resultId, error.message);
                    calculatorNotes.delete(resultId);
                    await saveCalculatorData();
                    updateRelationshipsCount();
                }
                
            } catch (error) {
                console.error('Error in recalculateResult:', error);
            }
        }

        // Save calculator data to board metadata
        async function saveCalculatorData() {
            try {
                const data = Object.fromEntries(calculatorNotes);
                await miro.board.setAppData('calculatorNotes', data);
                console.log('Saved calculator data to board metadata');
            } catch (error) {
                console.error('Error saving calculator data:', error);
            }
        }

        // Load calculator data from board metadata and clean up invalid ones immediately
        async function loadCalculatorData() {
            try {
                const data = await miro.board.getAppData('calculatorNotes');
                if (data) {
                    calculatorNotes = new Map(Object.entries(data));
                    console.log('Loaded calculator data from storage:', calculatorNotes.size, 'relationships');
                    
                    // Immediately verify and clean up invalid relationships
                    await verifyAndCleanupRelationships();
                } else {
                    console.log('No existing calculator data found');
                    calculatorNotes = new Map();
                }
            } catch (error) {
                console.error('Error loading calculator data:', error);
                calculatorNotes = new Map();
            }
        }

        // Verify all relationships and remove invalid ones (more thorough than cleanup)
        async function verifyAndCleanupRelationships() {
            console.log('Verifying all relationships on load...');
            const toDelete = [];
            
            for (const [resultId, calcData] of calculatorNotes.entries()) {
                let isValid = true;
                
                // Check if result note exists
                try {
                    const resultNote = await miro.board.getById(resultId);
                    if (!resultNote || resultNote.type !== 'sticky_note') {
                        console.log(`‚ùå Result note missing or wrong type: ${resultId}`);
                        isValid = false;
                    }
                } catch (error) {
                    console.log(`‚ùå Result note not found: ${resultId}`);
                    isValid = false;
                }
                
                // Check source notes
                let validSourceCount = 0;
                for (const sourceId of calcData.sourceIds) {
                    try {
                        const sourceNote = await miro.board.getById(sourceId);
                        if (sourceNote && sourceNote.type === 'sticky_note') {
                            validSourceCount++;
                        }
                    } catch (error) {
                        // Source note doesn't exist
                    }
                }
                
                if (validSourceCount < 2) {
                    console.log(`‚ùå Not enough valid sources: ${validSourceCount}/2 for ${resultId}`);
                    isValid = false;
                }
                
                if (!isValid) {
                    toDelete.push(resultId);
                }
            }
            
            // Remove invalid relationships
            if (toDelete.length > 0) {
                for (const resultId of toDelete) {
                    calculatorNotes.delete(resultId);
                    console.log(`üóëÔ∏è Removed invalid relationship: ${resultId}`);
                }
                
                await saveCalculatorData();
                console.log(`‚úÖ Cleaned up ${toDelete.length} invalid relationships on load`);
            } else {
                console.log('‚úÖ All relationships are valid');
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            if (status) {
                status.textContent = message;
                status.className = type;
                status.style.display = 'block';
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        // Start initialization when DOM loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>

