<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Miro Resource Calculator</title>
    <script src="https://miro.com/app/static/sdk/v2/miro.js?v=4"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 0;
            margin: 0;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 280px;
            height: 100vh;
            overflow-y: auto;
            padding: 15px;
            box-sizing: border-box;
        }

        h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 12px;
            padding: 12px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 5px;
        }

        .globals-grid {
            display: grid;
            grid-template-columns: 1fr 60px;
            gap: 8px;
            align-items: center;
        }

            .globals-grid label {
                font-size: 12px;
                font-weight: 500;
            }

            .globals-grid input {
                padding: 4px 6px;
                border: 1px solid #ced4da;
                border-radius: 3px;
                font-size: 11px;
                text-align: center;
            }

        button {
            width: 100%;
            padding: 8px;
            margin: 3px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .btn-sum {
            background: #ffc107;
            color: #000;
        }

        .btn-product {
            background: #28a745;
            color: white;
        }

        .btn-spawn {
            background: #6c757d;
            color: white;
        }

        .btn-expand {
            background: #17a2b8;
            color: white;
        }

        button:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        button:hover:not(:disabled) {
            opacity: 0.9;
        }

        #selection {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 11px;
            border: 1px solid #e9ecef;
        }

        .resource-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 8px;
        }

        .resource-btn {
            padding: 6px;
            font-size: 11px;
            border-radius: 3px;
            border: 1px solid #dee2e6;
        }

        .barrel-small {
            background: #fff3cd;
            color: #856404;
        }

        .barrel-medium {
            background: #ffeaa7;
            color: #6c5400;
        }

        .barrel-big {
            background: #fdcb6e;
            color: #5a4a00;
        }

        .dig {
            background: #d4edda;
            color: #155724;
        }

        .crate {
            background: #d1ecf1;
            color: #0c5460;
        }

        .pool-controls {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
            flex-direction: column;
        }

        .pool-select, .pool-input, .spawn-input {
            padding: 6px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 11px;
            background: white;
        }

        .pool-input, .spawn-input {
            text-align: center;
        }

        .pool-btn {
            flex: 1;
            padding: 6px;
            font-size: 11px;
        }

        .pool-create {
            background: #007bff;
            color: white;
            border: 1px solid #007bff;
        }

        .relationships-section {
            margin-top: 15px;
        }

        .toggle-btn {
            width: 100%;
            padding: 8px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            text-align: left;
        }

            .toggle-btn:hover {
                background: #e9ecef;
            }

        .relationships-list {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
        }

        .relationship-item {
            padding: 8px;
            margin: 4px;
            background: #f8f9fa;
            border-radius: 3px;
            border-left: 3px solid #007bff;
            font-size: 11px;
        }

            .relationship-item.sum {
                border-left-color: #ffc107;
            }

            .relationship-item.product {
                border-left-color: #28a745;
            }

        .relationship-header {
            font-weight: 600;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .relationship-name {
            font-size: 10px;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
            cursor: pointer;
        }

        .relationship-sources {
            font-size: 10px;
            color: #666;
            margin-bottom: 4px;
        }

        .relationship-actions {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }

        .action-btn {
            flex: 1;
            font-size: 9px;
            padding: 3px 6px;
            margin: 0;
        }

        .goto-btn {
            background: #007bff;
            color: white;
        }

        .select-parents-btn {
            background: #28a745;
            color: white;
        }

        .rename-btn {
            background: #17a2b8;
            color: white;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        #status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
            font-size: 12px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
        }

        .modal-content {
            background: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 6px;
            width: 250px;
            text-align: center;
        }

        .modal input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .modal button {
            margin: 5px;
            padding: 8px 16px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h3>Miro Resource Calculator</h3>

        <div class="section">
            <div class="section-title">Global Variables</div>
            <div class="globals-grid">
                <label>Barrel Small:</label>
                <input type="number" id="barrelSmall" value="5" min="1">
                <label>Barrel Medium:</label>
                <input type="number" id="barrelMedium" value="10" min="1">
                <label>Barrel Big:</label>
                <input type="number" id="barrelBig" value="20" min="1">
                <label>Dig:</label>
                <input type="number" id="digValue" value="3" min="1">
                <label>Crate:</label>
                <input type="number" id="crateValue" value="15" min="1">
            </div>
        </div>

        <div class="section">
            <div class="section-title">Calculator</div>
            <div id="selection">Select sticky notes with numbers</div>
            <button id="sumBtn" class="btn-sum" disabled>Create Sum</button>
            <button id="productBtn" class="btn-product" disabled>Create Product</button>
            <button id="expandBtn" class="btn-expand" disabled>Expand Relationship</button>
        </div>

        <div class="section">
            <div class="section-title">Create Resources</div>
            <div class="resource-controls">
                <button id="createBarrelSmall" class="resource-btn barrel-small">Small Barrel</button>
                <button id="createBarrelMedium" class="resource-btn barrel-medium">Med Barrel</button>
                <button id="createBarrelBig" class="resource-btn barrel-big">Big Barrel</button>
                <button id="createDig" class="resource-btn dig">Dig</button>
                <button id="createCrate" class="resource-btn crate">Crate</button>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Resource Pool Spawner</div>
            <div class="pool-controls">
                <select id="resourceTypeSelect" class="pool-select">
                    <option value="barrel-small">Small Barrel</option>
                    <option value="barrel-medium">Med Barrel</option>
                    <option value="barrel-big">Big Barrel</option>
                    <option value="dig">Dig</option>
                    <option value="crate">Crate</option>
                </select>
                <input type="number" id="poolQuantity" class="pool-input" min="2" max="20" value="3" placeholder="Quantity">
            </div>
            <button id="createResourcePool" class="pool-btn pool-create">Create Connected Pool</button>
        </div>

        <div class="section">
            <div class="section-title">Spawn Numbers</div>
            <input type="number" id="spawnCount" class="spawn-input" min="1" max="20" value="3" placeholder="Number to spawn">
            <button id="spawnBtn" class="btn-spawn">Spawn Connected Numbers</button>
        </div>

        <div class="relationships-section">
            <button id="toggleRelationships" class="toggle-btn">
                ‚ñº Show Relationships (<span id="relationshipCount">0</span>)
            </button>
            <div id="relationshipsList" class="relationships-list" style="display: none;">
                <div id="relationshipsContent">No calculator relationships found</div>
            </div>
        </div>

        <div id="status"></div>
    </div>

    <div id="renameModal" class="modal">
        <div class="modal-content">
            <h4>Rename Relationship</h4>
            <input type="text" id="renameInput" placeholder="Enter new name" maxlength="20">
            <div>
                <button id="confirmRename" class="btn-sum">Save</button>
                <button id="cancelRename" class="btn-spawn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        //JavaScript goes here
        // Miro Resource Calculator App - SDK v2 Compatible
        // Deployment timestamp: 2025-01-10
        console.log('üöÄ Miro Resource Calculator v2.0 - Loading...', new Date().toISOString());

        // Global state management
        let appState = {
            relationships: new Map(),
            globalVars: {
                barrelSmall: 5,
                barrelMedium: 10,
                barrelBig: 20,
                dig: 3,
                crate: 15
            },
            isRelationshipsVisible: false,
            initialized: false
        };

        // App metadata keys for persistence
        const RELATIONSHIPS_KEY = 'calculatorRelationships';
        const GLOBAL_VARS_KEY = 'globalVariables';
        const APP_VERSION = '2.0.0';

        // Cache busting - ensures fresh deployment
        const DEPLOYMENT_ID = Date.now();
        console.log('üì¶ Deployment ID:', DEPLOYMENT_ID);

        // Utility: Wait for DOM to be ready
        function waitForDOM() {
            return new Promise((resolve) => {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', resolve);
                } else {
                    resolve(null);
                }
            });
        }

        // Utility: Safely get DOM element with detailed logging
        function safeGetElement(id, required = false) {
            const element = document.getElementById(id);
            if (!element) {
                const message = `Element '${id}' not found`;
                if (required) {
                    console.error('‚ùå', message);
                } else {
                    console.warn('‚ö†Ô∏è', message);
                }
            }
            return element;
        }

        // Load persisted data from Miro's storage
        async function loadPersistedData() {
            try {
                console.log('üìÇ Loading persisted data...');

                // Load global variables from Miro app data
                const savedGlobals = await miro.board.getAppData(GLOBAL_VARS_KEY);
                if (savedGlobals) {
                    appState.globalVars = { ...appState.globalVars, ...savedGlobals };
                    console.log('‚úÖ Loaded global variables:', appState.globalVars);
                }

                // Load relationships using storage collection
                const relationshipsCollection = miro.board.storage.collection('relationships');
                const relationshipKeys = await relationshipsCollection.get('keys') || [];

                for (const key of relationshipKeys) {
                    const relationship = await relationshipsCollection.get(key);
                    if (relationship) {
                        appState.relationships.set(key, relationship);
                    }
                }

                console.log(`‚úÖ Loaded ${appState.relationships.size} relationships`);

            } catch (error) {
                console.error('‚ùå Error loading persisted data:', error);
            }
        }

        // Save data to Miro's storage
        async function saveData() {
            try {
                // Save global variables to app data
                await miro.board.setAppData(GLOBAL_VARS_KEY, appState.globalVars);

                // Save relationships to storage collection
                const relationshipsCollection = miro.board.storage.collection('relationships');
                const relationshipKeys = Array.from(appState.relationships.keys());

                // Store the list of keys
                await relationshipsCollection.set('keys', relationshipKeys);

                // Store each relationship
                for (const [key, relationship] of appState.relationships) {
                    await relationshipsCollection.set(key, relationship);
                }

            } catch (error) {
                console.error('‚ùå Error saving data:', error);
                throw error;
            }
        }

        // Handle global variable changes
        async function handleGlobalVariableChange(event) {
            const inputId = event.target.id;
            const value = parseInt(event.target.value) || 1;

            const mapping = {
                'barrelSmall': 'barrelSmall',
                'barrelMedium': 'barrelMedium',
                'barrelBig': 'barrelBig',
                'digValue': 'dig',
                'crateValue': 'crate'
            };

            if (mapping[inputId]) {
                appState.globalVars[mapping[inputId]] = value;
                await saveData();
                showStatus('Global variables updated', 'success');
                console.log('üíæ Updated global variable:', inputId, '=', value);
            }
        }

        // Setup all event handlers for UI elements - NO .onclick assignments
        function setupEventHandlers() {
            console.log('üîß Setting up event handlers...');

            // Global variables input handlers
            const globalInputs = [
                'barrelSmall', 'barrelMedium', 'barrelBig', 'digValue', 'crateValue'
            ];

            globalInputs.forEach(inputId => {
                const input = safeGetElement(inputId);
                if (input) {
                    input.addEventListener('change', handleGlobalVariableChange);
                    console.log('‚úÖ Added change listener to:', inputId);
                }
            });

            // Calculator button handlers
            const calculatorButtons = [
                { id: 'sumBtn', handler: createSum, name: 'Sum' },
                { id: 'productBtn', handler: createProduct, name: 'Product' },
                { id: 'expandBtn', handler: expandRelationship, name: 'Expand' }
            ];

            calculatorButtons.forEach(({ id, handler, name }) => {
                const button = safeGetElement(id);
                if (button) {
                    button.addEventListener('click', handler);
                    console.log('‚úÖ Added click listener to:', name, 'button');
                }
            });

            // Resource creation handlers
            const resourceButtons = [
                { id: 'createBarrelSmall', resource: 'barrel-small', name: 'Small Barrel' },
                { id: 'createBarrelMedium', resource: 'barrel-medium', name: 'Med Barrel' },
                { id: 'createBarrelBig', resource: 'barrel-big', name: 'Big Barrel' },
                { id: 'createDig', resource: 'dig', name: 'Dig' },
                { id: 'createCrate', resource: 'crate', name: 'Crate' }
            ];

            resourceButtons.forEach(({ id, resource, name }) => {
                const button = safeGetElement(id);
                if (button) {
                    button.addEventListener('click', function () {
                        createResource(resource);
                    });
                    console.log('‚úÖ Added click listener to:', name, 'resource button');
                }
            });

            // Pool and spawn handlers
            const poolBtn = safeGetElement('createResourcePool');
            if (poolBtn) {
                poolBtn.addEventListener('click', createResourcePool);
                console.log('‚úÖ Added click listener to: Resource Pool button');
            }

            const spawnBtn = safeGetElement('spawnBtn');
            if (spawnBtn) {
                spawnBtn.addEventListener('click', spawnNumbers);
                console.log('‚úÖ Added click listener to: Spawn button');
            }

            // Relationships panel handlers
            const toggleBtn = safeGetElement('toggleRelationships');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleRelationships);
                console.log('‚úÖ Added click listener to: Toggle Relationships button');
            }

            // Modal handlers
            const confirmBtn = safeGetElement('confirmRename');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', confirmRename);
                console.log('‚úÖ Added click listener to: Confirm Rename button');
            }

            const cancelBtn = safeGetElement('cancelRename');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelRename);
                console.log('‚úÖ Added click listener to: Cancel Rename button');
            }

            // Close modal when clicking outside
            const modal = safeGetElement('renameModal');
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target.id === 'renameModal') {
                        cancelRename();
                    }
                });
                console.log('‚úÖ Added click listener to: Rename Modal');
            }

            console.log('üîß Event handlers setup complete');
        }

        // Setup Miro board event listeners
        async function setupMiroEventListeners() {
            try {
                console.log('üéØ Setting up Miro event listeners...');

                // IMPORTANT: Listen for icon click to open panel
                await miro.board.ui.on('icon:click', async () => {
                    console.log('üñ±Ô∏è App icon clicked - opening panel...');
                    await miro.board.ui.openPanel({
                        url: window.location.href
                    });
                });
                console.log('‚úÖ Registered icon:click listener');

                // Listen for selection changes
                await miro.board.ui.on('selection:update', handleSelectionChange);
                console.log('‚úÖ Registered selection:update listener');

                // Listen for item updates that might affect our relationships
                await miro.board.ui.on('experimental:items:update', handleItemsUpdate);
                console.log('‚úÖ Registered experimental:items:update listener');

                // Listen for item deletion to clean up relationships
                await miro.board.ui.on('items:delete', handleItemsDelete);
                console.log('‚úÖ Registered items:delete listener');

                console.log('üéØ Miro event listeners setup complete');

            } catch (error) {
                console.error('‚ùå Error setting up Miro event listeners:', error);
                throw error;
            }
        }

        // Handle selection changes on the board
        async function handleSelectionChange() {
            try {
                await updateSelectionStatus();
            } catch (error) {
                console.error('‚ùå Error handling selection change:', error);
            }
        }

        // Handle item updates
        async function handleItemsUpdate(event) {
            try {
                if (event.items) {
                    for (const item of event.items) {
                        await updateRelationshipsForItem(item.id);
                    }
                }
                await updateRelationshipsUI();
            } catch (error) {
                console.error('‚ùå Error handling items update:', error);
            }
        }

        // Handle item deletion
        async function handleItemsDelete(event) {
            try {
                if (event.items) {
                    for (const item of event.items) {
                        await cleanupRelationshipsForItem(item.id);
                    }
                }
                await updateRelationshipsUI();
                await saveData();
            } catch (error) {
                console.error('‚ùå Error handling items delete:', error);
            }
        }

        // Update the global variables UI with current values
        function updateGlobalVariablesUI() {
            const updates = [
                { id: 'barrelSmall', value: appState.globalVars.barrelSmall },
                { id: 'barrelMedium', value: appState.globalVars.barrelMedium },
                { id: 'barrelBig', value: appState.globalVars.barrelBig },
                { id: 'digValue', value: appState.globalVars.dig },
                { id: 'crateValue', value: appState.globalVars.crate }
            ];

            updates.forEach(({ id, value }) => {
                const element = safeGetElement(id);
                if (element) {
                    element.value = value;
                }
            });

            console.log('üîÑ Updated global variables UI');
        }

        // Update selection status and enable/disable buttons
        async function updateSelectionStatus() {
            try {
                const selection = await miro.board.getSelection();
                const validItems = selection.filter(item =>
                    item.type === 'sticky_note' && hasNumericContent(item.content)
                );

                const count = validItems.length;
                const hasValidSelection = count >= 2;

                // Update selection display
                const selectionDiv = safeGetElement('selection');
                if (selectionDiv) {
                    if (count === 0) {
                        selectionDiv.textContent = 'Select sticky notes with numbers';
                    } else if (count === 1) {
                        selectionDiv.textContent = `1 numeric sticky note selected (need 2+)`;
                    } else {
                        selectionDiv.textContent = `${count} numeric sticky notes selected`;
                    }
                }

                // Enable/disable buttons safely
                const sumBtn = safeGetElement('sumBtn');
                const productBtn = safeGetElement('productBtn');
                const expandBtn = safeGetElement('expandBtn');

                if (sumBtn) sumBtn.disabled = !hasValidSelection;
                if (productBtn) productBtn.disabled = !hasValidSelection;
                if (expandBtn) expandBtn.disabled = count !== 1 || !isResultNote(validItems[0]);

            } catch (error) {
                console.error('‚ùå Error updating selection status:', error);
            }
        }

        // Extract numeric value from content
        function extractNumericValue(content) {
            if (!content) return null;

            // Look for numbers in parentheses first: "Small Barrel (10)"
            const parenMatch = content.match(/\((\d+(?:\.\d+)?)\)/);
            if (parenMatch) {
                return parseFloat(parenMatch[1]);
            }

            // Look for standalone numbers
            const numberMatch = content.match(/(\d+(?:\.\d+)?)/);
            if (numberMatch) {
                return parseFloat(numberMatch[1]);
            }

            return null;
        }

        // Check if content has numeric value
        function hasNumericContent(content) {
            return extractNumericValue(content) !== null;
        }

        // Check if a sticky note is a result from our calculator
        function isResultNote(item) {
            if (!item || !item.content) return false;
            return item.content.includes('Sum:') || item.content.includes('Product:');
        }

        // Create sum calculation
        async function createSum() {
            try {
                console.log('üßÆ Creating sum calculation...');

                const selection = await miro.board.getSelection();
                const validItems = selection.filter(item =>
                    item.type === 'sticky_note' && hasNumericContent(item.content)
                );

                if (validItems.length < 2) {
                    showStatus('Select at least 2 sticky notes with numbers', 'error');
                    return;
                }

                const values = validItems.map(item => extractNumericValue(item.content));
                const sum = values.reduce((acc, val) => acc + val, 0);

                // Calculate position for result note
                const avgX = validItems.reduce((acc, item) => acc + item.x, 0) / validItems.length;
                const avgY = validItems.reduce((acc, item) => acc + item.y, 0) / validItems.length;

                // Create result sticky note
                const resultNote = await miro.board.createStickyNote({
                    content: `Sum: ${sum}`,
                    x: avgX,
                    y: avgY - 100,
                    style: {
                        fillColor: 'light_yellow',
                        textAlign: 'center'
                    }
                });

                // Create relationship
                const relationshipId = generateRelationshipId();
                const relationship = {
                    id: relationshipId,
                    type: 'sum',
                    name: `Sum ${relationshipId.slice(-6)}`,
                    result: resultNote.id,
                    sources: validItems.map(item => item.id),
                    values: values,
                    resultValue: sum,
                    createdAt: Date.now()
                };

                appState.relationships.set(relationshipId, relationship);

                // Store relationship metadata in result note
                await resultNote.setMetadata('calculatorRelationship', relationshipId);

                await saveData();
                await updateRelationshipsUI();

                showStatus(`Sum created: ${sum}`, 'success');
                console.log('‚úÖ Sum calculation created:', sum);

            } catch (error) {
                console.error('‚ùå Error creating sum:', error);
                showStatus('Error creating sum: ' + error.message, 'error');
            }
        }

        // Create product calculation
        async function createProduct() {
            try {
                console.log('üßÆ Creating product calculation...');

                const selection = await miro.board.getSelection();
                const validItems = selection.filter(item =>
                    item.type === 'sticky_note' && hasNumericContent(item.content)
                );

                if (validItems.length < 2) {
                    showStatus('Select at least 2 sticky notes with numbers', 'error');
                    return;
                }

                const values = validItems.map(item => extractNumericValue(item.content));
                const product = values.reduce((acc, val) => acc * val, 1);

                // Calculate position for result note
                const avgX = validItems.reduce((acc, item) => acc + item.x, 0) / validItems.length;
                const avgY = validItems.reduce((acc, item) => acc + item.y, 0) / validItems.length;

                // Create result sticky note
                const resultNote = await miro.board.createStickyNote({
                    content: `Product: ${product}`,
                    x: avgX,
                    y: avgY - 100,
                    style: {
                        fillColor: '#28a745',
                        textAlign: 'center'
                    }
                });

                // Create relationship
                const relationshipId = generateRelationshipId();
                const relationship = {
                    id: relationshipId,
                    type: 'product',
                    name: `Product ${relationshipId.slice(-6)}`,
                    result: resultNote.id,
                    sources: validItems.map(item => item.id),
                    values: values,
                    resultValue: product,
                    createdAt: Date.now()
                };

                appState.relationships.set(relationshipId, relationship);

                // Store relationship metadata in result note
                await resultNote.setMetadata('calculatorRelationship', relationshipId);

                await saveData();
                await updateRelationshipsUI();

                showStatus(`Product created: ${product}`, 'success');
                console.log('‚úÖ Product calculation created:', product);

            } catch (error) {
                console.error('‚ùå Error creating product:', error);
                showStatus('Error creating product: ' + error.message, 'error');
            }
        }

        // Expand relationship (show sources)
        async function expandRelationship() {
            try {
                console.log('üîç Expanding relationship...');

                const selection = await miro.board.getSelection();
                if (selection.length !== 1) {
                    showStatus('Select exactly one result note', 'error');
                    return;
                }

                const selectedItem = selection[0];
                const relationshipId = await selectedItem.getMetadata('calculatorRelationship');

                if (!relationshipId || !appState.relationships.has(relationshipId)) {
                    showStatus('Selected note is not a calculator result', 'error');
                    return;
                }

                const relationship = appState.relationships.get(relationshipId);
                const sourceIds = [...relationship.sources, relationship.result];

                // Select all related items
                await miro.board.select({ id: sourceIds });

                // Focus viewport on the items
                const items = [];
                for (const id of sourceIds) {
                    try {
                        const item = await miro.board.getById(id);
                        items.push(item);
                    } catch (e) {
                        console.log('‚ö†Ô∏è Item not found:', id);
                    }
                }

                if (items.length > 0) {
                    await miro.board.viewport.zoomTo(items);
                }

                showStatus('Relationship expanded', 'success');
                console.log('‚úÖ Relationship expanded');

            } catch (error) {
                console.error('‚ùå Error expanding relationship:', error);
                showStatus('Error expanding relationship: ' + error.message, 'error');
            }
        }

        // Create resource sticky note
        async function createResource(resourceType) {
            try {
                console.log('üì¶ Creating resource:', resourceType);

                const resourceValues = {
                    'barrel-small': { value: appState.globalVars.barrelSmall, name: 'Small Barrel', color: 'light_yellow' },
                    'barrel-medium': { value: appState.globalVars.barrelMedium, name: 'Med Barrel', color: 'yellow' },
                    'barrel-big': { value: appState.globalVars.barrelBig, name: 'Big Barrel', color: 'orange' },
                    'dig': { value: appState.globalVars.dig, name: 'Dig', color: 'light_green' },
                    'crate': { value: appState.globalVars.crate, name: 'Crate', color: 'light_blue' }
                };

                const resource = resourceValues[resourceType];
                if (!resource) {
                    console.warn('‚ö†Ô∏è Unknown resource type:', resourceType);
                    return;
                }

                const viewport = await miro.board.viewport.get();
                const centerX = viewport.x + viewport.width / 2;
                const centerY = viewport.y + viewport.height / 2;

                await miro.board.createStickyNote({
                    content: `${resource.name} (${resource.value})`,
                    x: centerX + (Math.random() - 0.5) * 200,
                    y: centerY + (Math.random() - 0.5) * 200,
                    style: {
                        fillColor: resource.color,
                        textAlign: 'center'
                    }
                });

                showStatus(`${resource.name} created`, 'success');
                console.log('‚úÖ Resource created:', resource.name);

            } catch (error) {
                console.error('‚ùå Error creating resource:', error);
                showStatus('Error creating resource: ' + error.message, 'error');
            }
        }

        // Create resource pool
        async function createResourcePool() {
            try {
                console.log('üè≠ Creating resource pool...');

                const resourceTypeSelect = safeGetElement('resourceTypeSelect');
                const poolQuantityInput = safeGetElement('poolQuantity');

                if (!resourceTypeSelect || !poolQuantityInput) {
                    showStatus('Resource pool controls not found', 'error');
                    return;
                }

                const resourceType = resourceTypeSelect.value;
                const quantity = parseInt(poolQuantityInput.value) || 3;

                if (quantity < 2 || quantity > 20) {
                    showStatus('Quantity must be between 2 and 20', 'error');
                    return;
                }

                const resourceValues = {
                    'barrel-small': { value: appState.globalVars.barrelSmall, name: 'Small Barrel', color: 'light_yellow' },
                    'barrel-medium': { value: appState.globalVars.barrelMedium, name: 'Med Barrel', color: 'yellow' },
                    'barrel-big': { value: appState.globalVars.barrelBig, name: 'Big Barrel', color: 'orange' },
                    'dig': { value: appState.globalVars.dig, name: 'Dig', color: 'light_green' },
                    'crate': { value: appState.globalVars.crate, name: 'Crate', color: 'light_blue' }
                };

                const resource = resourceValues[resourceType];
                if (!resource) return;

                const viewport = await miro.board.viewport.get();
                const centerX = viewport.x + viewport.width / 2;
                const centerY = viewport.y + viewport.height / 2;

                const notes = [];
                const spacing = 120;
                const cols = Math.ceil(Math.sqrt(quantity));

                for (let i = 0; i < quantity; i++) {
                    const row = Math.floor(i / cols);
                    const col = i % cols;
                    const x = centerX + (col - (cols - 1) / 2) * spacing;
                    const y = centerY + (row - Math.floor((quantity - 1) / cols) / 2) * spacing;

                    const note = await miro.board.createStickyNote({
                        content: `${resource.name} (${resource.value})`,
                        x: x,
                        y: y,
                        style: {
                            fillColor: resource.color,
                            textAlign: 'center'
                        }
                    });

                    notes.push(note);
                }

                // Create connectors between notes
                for (let i = 0; i < notes.length - 1; i++) {
                    await miro.board.createConnector({
                        start: { item: notes[i].id },
                        end: { item: notes[i + 1].id },
                        style: { strokeColor: '#666' }
                    });
                }

                showStatus(`Resource pool of ${quantity} ${resource.name}s created`, 'success');
                console.log('‚úÖ Resource pool created:', quantity, resource.name);

            } catch (error) {
                console.error('‚ùå Error creating resource pool:', error);
                showStatus('Error creating resource pool: ' + error.message, 'error');
            }
        }

        // Spawn connected numbers
        async function spawnNumbers() {
            try {
                console.log('üî¢ Spawning connected numbers...');

                const spawnCountInput = safeGetElement('spawnCount');
                if (!spawnCountInput) {
                    showStatus('Spawn count input not found', 'error');
                    return;
                }

                const count = parseInt(spawnCountInput.value) || 3;

                if (count < 1 || count > 20) {
                    showStatus('Count must be between 1 and 20', 'error');
                    return;
                }

                const viewport = await miro.board.viewport.get();
                const centerX = viewport.x + viewport.width / 2;
                const centerY = viewport.y + viewport.height / 2;

                const notes = [];
                const spacing = 100;

                for (let i = 0; i < count; i++) {
                    const angle = (i / count) * 2 * Math.PI;
                    const x = centerX + Math.cos(angle) * spacing;
                    const y = centerY + Math.sin(angle) * spacing;

                    const note = await miro.board.createStickyNote({
                        content: (i + 1).toString(),
                        x: x,
                        y: y,
                        style: {
                            fillColor: 'gray',
                            textAlign: 'center'
                        }
                    });

                    notes.push(note);
                }

                // Create connectors between consecutive notes
                for (let i = 0; i < notes.length; i++) {
                    const nextIndex = (i + 1) % notes.length;
                    await miro.board.createConnector({
                        start: { item: notes[i].id },
                        end: { item: notes[nextIndex].id },
                        style: { strokeColor: '#666' }
                    });
                }

                showStatus(`${count} connected numbers spawned`, 'success');
                console.log('‚úÖ Connected numbers spawned:', count);

            } catch (error) {
                console.error('‚ùå Error spawning numbers:', error);
                showStatus('Error spawning numbers: ' + error.message, 'error');
            }
        }

        // Toggle relationships panel visibility
        function toggleRelationships() {
            appState.isRelationshipsVisible = !appState.isRelationshipsVisible;
            const relationshipsList = safeGetElement('relationshipsList');
            const toggleBtn = safeGetElement('toggleRelationships');

            if (relationshipsList && toggleBtn) {
                if (appState.isRelationshipsVisible) {
                    relationshipsList.style.display = 'block';
                    toggleBtn.textContent = toggleBtn.textContent.replace('‚ñº', '‚ñ≤');
                } else {
                    relationshipsList.style.display = 'none';
                    toggleBtn.textContent = toggleBtn.textContent.replace('‚ñ≤', '‚ñº');
                }
            }

            console.log('üîÑ Toggled relationships visibility:', appState.isRelationshipsVisible);
        }

        // Update relationships UI
        async function updateRelationshipsUI() {
            const count = appState.relationships.size;
            const countElement = safeGetElement('relationshipCount');
            if (countElement) {
                countElement.textContent = count;
            }

            const content = safeGetElement('relationshipsContent');
            if (!content) return;

            if (count === 0) {
                content.innerHTML = 'No calculator relationships found';
                return;
            }

            const relationships = Array.from(appState.relationships.values())
                .sort((a, b) => b.createdAt - a.createdAt);

            content.innerHTML = relationships.map(rel => `
        <div class="relationship-item ${rel.type}">
            <div class="relationship-header" onclick="gotoRelationship('${rel.id}')">
                <span>${rel.type === 'sum' ? 'Sum' : 'Product'}: ${rel.resultValue}</span>
                <span class="relationship-name" onclick="event.stopPropagation(); renameRelationship('${rel.id}')">${rel.name}</span>
            </div>
            <div class="relationship-sources">Sources: ${rel.values.join(' + ')}</div>
            <div class="relationship-actions">
                <button class="action-btn goto-btn" onclick="gotoRelationship('${rel.id}')">Go To</button>
                <button class="action-btn select-parents-btn" onclick="selectParents('${rel.id}')">Select Parents</button>
                <button class="action-btn rename-btn" onclick="renameRelationship('${rel.id}')">Rename</button>
                <button class="action-btn delete-btn" onclick="deleteRelationship('${rel.id}')">Delete</button>
            </div>
        </div>
    `).join('');

            console.log('üîÑ Updated relationships UI:', count, 'relationships');
        }

        // Go to relationship items
        async function gotoRelationship(relationshipId) {
            try {
                const relationship = appState.relationships.get(relationshipId);
                if (!relationship) return;

                const allIds = [...relationship.sources, relationship.result];
                const items = [];

                for (const id of allIds) {
                    try {
                        const item = await miro.board.getById(id);
                        items.push(item);
                    } catch (e) {
                        console.log('‚ö†Ô∏è Item not found:', id);
                    }
                }

                if (items.length > 0) {
                    await miro.board.select({ id: items.map(item => item.id) });
                    await miro.board.viewport.zoomTo(items);
                }

            } catch (error) {
                console.error('‚ùå Error going to relationship:', error);
                showStatus('Error navigating to relationship', 'error');
            }
        }

        // Select parent items only
        async function selectParents(relationshipId) {
            try {
                const relationship = appState.relationships.get(relationshipId);
                if (!relationship) return;

                const items = [];
                for (const id of relationship.sources) {
                    try {
                        const item = await miro.board.getById(id);
                        items.push(item);
                    } catch (e) {
                        console.log('‚ö†Ô∏è Item not found:', id);
                    }
                }

                if (items.length > 0) {
                    await miro.board.select({ id: items.map(item => item.id) });
                    await miro.board.viewport.zoomTo(items);
                }

            } catch (error) {
                console.error('‚ùå Error selecting parents:', error);
                showStatus('Error selecting parent items', 'error');
            }
        }

        // Rename relationship
        let currentRenameId = null;

        function renameRelationship(relationshipId) {
            const relationship = appState.relationships.get(relationshipId);
            if (!relationship) return;

            currentRenameId = relationshipId;
            const renameInput = safeGetElement('renameInput');
            const modal = safeGetElement('renameModal');

            if (renameInput && modal) {
                renameInput.value = relationship.name;
                modal.style.display = 'block';
                renameInput.focus();
            }

            console.log('‚úèÔ∏è Renaming relationship:', relationshipId);
        }

        async function confirmRename() {
            if (!currentRenameId) return;

            const renameInput = safeGetElement('renameInput');
            if (!renameInput) return;

            const newName = renameInput.value.trim();
            if (!newName) {
                showStatus('Name cannot be empty', 'error');
                return;
            }

            const relationship = appState.relationships.get(currentRenameId);
            if (relationship) {
                relationship.name = newName;
                await saveData();
                await updateRelationshipsUI();
                showStatus('Relationship renamed', 'success');
                console.log('‚úÖ Relationship renamed:', newName);
            }

            cancelRename();
        }

        function cancelRename() {
            currentRenameId = null;
            const modal = safeGetElement('renameModal');
            const input = safeGetElement('renameInput');

            if (modal) modal.style.display = 'none';
            if (input) input.value = '';

            console.log('‚ùå Rename cancelled');
        }

        // Delete relationship
        async function deleteRelationship(relationshipId) {
            try {
                const relationship = appState.relationships.get(relationshipId);
                if (!relationship) return;

                if (!confirm(`Delete relationship "${relationship.name}"?`)) return;

                // Remove relationship
                appState.relationships.delete(relationshipId);

                // Clean up metadata from result note
                try {
                    const resultItem = await miro.board.getById(relationship.result);
                    await resultItem.setMetadata('calculatorRelationship', null);
                } catch (e) {
                    console.log('‚ö†Ô∏è Result item not found or already deleted');
                }

                await saveData();
                await updateRelationshipsUI();
                showStatus('Relationship deleted', 'success');
                console.log('üóëÔ∏è Relationship deleted:', relationshipId);

            } catch (error) {
                console.error('‚ùå Error deleting relationship:', error);
                showStatus('Error deleting relationship', 'error');
            }
        }

        // Utility functions
        function generateRelationshipId() {
            return `rel_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        async function updateRelationshipsForItem(itemId) {
            // Check if this item is part of any relationships and update if needed
            for (const [id, relationship] of appState.relationships) {
                if (relationship.sources.includes(itemId) || relationship.result === itemId) {
                    try {
                        const item = await miro.board.getById(itemId);
                        // Update relationship data if needed
                        if (relationship.result === itemId && item.content) {
                            // Update result value if result note content changed
                            const match = item.content.match(/(Sum|Product): ([\d.]+)/);
                            if (match) {
                                relationship.resultValue = parseFloat(match[2]);
                            }
                        }
                    } catch (e) {
                        console.log('‚ö†Ô∏è Item not found during update:', itemId);
                    }
                }
            }
        }

        async function cleanupRelationshipsForItem(itemId) {
            // Remove relationships that reference deleted items
            const toDelete = [];

            for (const [id, relationship] of appState.relationships) {
                if (relationship.sources.includes(itemId) || relationship.result === itemId) {
                    toDelete.push(id);
                }
            }

            for (const id of toDelete) {
                appState.relationships.delete(id);
                console.log('üßπ Cleaned up relationship:', id);
            }
        }

        // Show status message
        function showStatus(message, type = 'success') {
            const statusDiv = safeGetElement('status');
            if (!statusDiv) return;

            statusDiv.textContent = message;
            statusDiv.className = type;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);

            console.log(`üí¨ Status [${type}]:`, message);
        }

        // Handle keyboard events
        document.addEventListener('keydown', (e) => {
            // Handle Enter key in rename modal
            if (e.key === 'Enter' && currentRenameId &&
                safeGetElement('renameModal') &&
                safeGetElement('renameModal').style.display === 'block') {
                e.preventDefault();
                confirmRename();
            }

            // Handle Escape key to close modal
            if (e.key === 'Escape' && currentRenameId) {
                e.preventDefault();
                cancelRename();
            }
        });

        // Make functions globally accessible for onclick handlers in HTML
        window.gotoRelationship = gotoRelationship;
        window.selectParents = selectParents;
        window.renameRelationship = renameRelationship;
        window.deleteRelationship = deleteRelationship;

        // Data validation and cleanup
        async function validateAndCleanData() {
            const toDelete = [];

            for (const [id, relationship] of appState.relationships) {
                let isValid = true;

                // Check if result item still exists
                try {
                    await miro.board.getById(relationship.result);
                } catch (e) {
                    isValid = false;
                }

                // Check if source items still exist
                for (const sourceId of relationship.sources) {
                    try {
                        await miro.board.getById(sourceId);
                    } catch (e) {
                        isValid = false;
                        break;
                    }
                }

                if (!isValid) {
                    toDelete.push(id);
                }
            }

            // Remove invalid relationships
            for (const id of toDelete) {
                appState.relationships.delete(id);
            }

            if (toDelete.length > 0) {
                await saveData();
                await updateRelationshipsUI();
                showStatus(`Cleaned up ${toDelete.length} invalid relationship(s)`, 'success');
                console.log('üßπ Data validation completed:', toDelete.length, 'invalid relationships removed');
            }
        }

        // Debug functions (available in console)
        window.debugMiroCalculator = {
            getState: () => appState,
            validateData: validateAndCleanData,
            clearAllData: async () => {
                if (confirm('Clear all calculator data? This cannot be undone.')) {
                    appState.relationships.clear();
                    await miro.board.setAppData(RELATIONSHIPS_KEY, null);
                    const relationshipsCollection = miro.board.storage.collection('relationships');
                    await relationshipsCollection.set('keys', []);
                    await updateRelationshipsUI();
                    showStatus('All data cleared', 'success');
                    console.log('üßπ All data cleared');
                }
            },
            deploymentId: DEPLOYMENT_ID,
            version: APP_VERSION
        };

        // Initialize the app
        async function initializeApp() {
            if (appState.initialized) {
                console.log('‚ö†Ô∏è App already initialized, skipping...');
                return;
            }

            try {
                console.log('üöÄ Initializing Miro Resource Calculator...');

                // Wait for DOM to be ready
                await waitForDOM();
                console.log('‚úÖ DOM ready');

                // Verify critical elements exist
                const criticalElements = [
                    'barrelSmall', 'barrelMedium', 'barrelBig', 'digValue', 'crateValue',
                    'sumBtn', 'productBtn', 'expandBtn', 'selection'
                ];

                let missingElements = [];
                for (const elementId of criticalElements) {
                    if (!document.getElementById(elementId)) {
                        missingElements.push(elementId);
                    }
                }

                if (missingElements.length > 0) {
                    throw new Error(`Missing critical DOM elements: ${missingElements.join(', ')}`);
                }
                console.log('‚úÖ All critical DOM elements found');

                // Load persistent data
                await loadPersistedData();

                // Setup event handlers
                setupEventHandlers();

                // Setup Miro board event listeners
                await setupMiroEventListeners();

                // Update UI with loaded data
                updateGlobalVariablesUI();
                await updateSelectionStatus();
                await updateRelationshipsUI();

                // Start periodic data validation
                setInterval(validateAndCleanData, 30000);
                console.log('‚úÖ Started periodic data validation (30s interval)');

                // Mark as initialized
                appState.initialized = true;

                console.log('üéâ Miro Resource Calculator initialized successfully!');
                showStatus('App initialized successfully', 'success');

            } catch (error) {
                console.error('‚ùå Failed to initialize app:', error);
                showStatus('Failed to initialize app: ' + error.message, 'error');
                throw error;
            }
        }

        // Error handling for unhandled promises
        window.addEventListener('unhandledrejection', (event) => {
            console.error('‚ùå Unhandled promise rejection:', event.reason);
            showStatus('An unexpected error occurred', 'error');
        });

        // Prevent duplicate initialization
        window.addEventListener('beforeunload', () => {
            console.log('üëã App unloading...');
        });

        // Start the app
        async function startApp() {
            try {
                console.log('üöÄ Starting Miro Resource Calculator App...');
                console.log('üìã Deployment ID:', DEPLOYMENT_ID);
                console.log('üìã App Version:', APP_VERSION);

                // Wait for DOM to be ready
                await waitForDOM();
                console.log('‚úÖ DOM ready for initialization');

                // Check if Miro SDK is available
                if (!window.miro) {
                    throw new Error('Miro SDK not available - make sure the SDK script is loaded');
                }
                console.log('‚úÖ Miro SDK detected');

                // Initialize the app
                await initializeApp();

                console.log('üéâ App started successfully!');

            } catch (error) {
                console.error('‚ùå Failed to start app:', error);

                // Try to show error in multiple ways
                const statusDiv = document.getElementById('status');
                if (statusDiv) {
                    statusDiv.textContent = 'Failed to start app: ' + error.message;
                    statusDiv.className = 'error';
                    statusDiv.style.display = 'block';
                }

                // Also show alert as fallback
                alert('Failed to start app: ' + error.message);

                // Log detailed error info
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    deploymentId: DEPLOYMENT_ID,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // Start the app immediately - cache busting ensures fresh execution
        startApp();
    </script>
</body>
</html>
